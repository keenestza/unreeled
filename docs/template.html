<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UNREELED — Daily Media Releases</title>
<meta name="description" content="Track daily releases across movies, TV, books, games, anime, music and podcasts. Spoiler-tagged discussions and personalized feeds.">
<!-- SEO / Open Graph -->
<meta property="og:title" content="UNREELED — Daily Media Releases">
<meta property="og:description" content="Track daily releases across movies, TV, books, games, anime, music and podcasts with spoiler-tagged discussions.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://unreeled.netlify.app">
<meta property="og:image" content="https://unreeled.netlify.app/og-image.png">
<meta property="og:site_name" content="UNREELED">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="UNREELED — Daily Media Releases">
<meta name="twitter:description" content="Track daily releases across movies, TV, books, games, anime, music and podcasts.">
<meta name="twitter:image" content="https://unreeled.netlify.app/og-image.png">
<!-- PWA -->
<meta name="theme-color" content="#ff6b35">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='36' fill='%23ff6b35'/><text x='45' y='135' font-size='120' font-weight='bold' fill='white'>U</text></svg>">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23ff6b35'/><text x='8' y='24' font-size='22' font-weight='bold' fill='white'>U</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#08090c;--card:#0f1014;--el:#16171d;--hov:#1c1d25;--accent:#ff6b35;--agl:rgba(255,107,53,0.12);--text:#e8e8ec;--ts:#a0a0ae;--td:#5e5e6e;--brd:#1e1f28;--bl:#282935;--sl:#3ec98c;--slb:rgba(62,201,140,0.08);--slr:rgba(62,201,140,0.25);--sm:#f0c038;--smb:rgba(240,192,56,0.08);--smr:rgba(240,192,56,0.25);--sh:#ef4444;--shb:rgba(239,68,68,0.08);--shr:rgba(239,68,68,0.25)}
/* LIGHT MODE */
[data-theme="light"]{--bg:#f5f5f7;--card:#ffffff;--el:#f0f0f3;--hov:#e8e8ec;--accent:#e85d2a;--agl:rgba(232,93,42,0.1);--text:#1a1a2e;--ts:#4a4a5e;--td:#8a8a9e;--brd:#dddde5;--bl:#c8c8d4;--sl:#2aa66e;--slb:rgba(42,166,110,0.08);--slr:rgba(42,166,110,0.2);--sm:#c8960a;--smb:rgba(200,150,10,0.08);--smr:rgba(200,150,10,0.2);--sh:#dc2626;--shb:rgba(220,38,38,0.06);--shr:rgba(220,38,38,0.2)}
[data-theme="light"] .nav{background:rgba(245,245,247,0.92)}
[data-theme="light"] .bnav{background:rgba(245,245,247,0.96)}
[data-theme="light"] .modal-bg{background:rgba(0,0,0,0.3)}
[data-theme="light"] .pb img{box-shadow:0 2px 8px rgba(0,0,0,0.1)}
/* THEME TOGGLE */
.theme-btn{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;background:var(--el);border:1px solid var(--brd);transition:all .15s;cursor:pointer}
.theme-btn:hover{background:var(--hov);border-color:var(--bl)}
/* SKELETON LOADING */
.skel{background:linear-gradient(90deg,var(--el) 25%,var(--hov) 50%,var(--el) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:8px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skel-card{height:90px;margin-bottom:8px;border-radius:12px}
.skel-line{height:14px;margin-bottom:8px;border-radius:4px}
.skel-line.w60{width:60%}.skel-line.w40{width:40%}.skel-line.w80{width:80%}
/* NEW TODAY BADGE */
.new-badge{display:inline-block;padding:2px 6px;background:var(--accent);color:#fff;border-radius:4px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-left:6px;vertical-align:middle;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
/* EMPTY STATES */
.empty{text-align:center;padding:48px 20px}
.empty-icon{font-size:48px;margin-bottom:12px;display:block}
.empty h2{font-family:'Fraunces',serif;font-size:20px;margin-bottom:6px}
.empty p{color:var(--td);font-size:14px;max-width:320px;margin:0 auto}
.empty a{color:var(--accent);cursor:pointer}
/* STAR RATING */
.stars{display:inline-flex;gap:2px}.stars span{cursor:pointer;font-size:18px;color:var(--brd);transition:all .12s}.stars span:hover,.stars span.on{color:#f0c038}
.avg-rating{display:inline-flex;align-items:center;gap:4px;font-size:12px;color:var(--td)}.avg-rating em{font-style:normal;font-weight:700;color:var(--sm)}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;-webkit-font-smoothing:antialiased}
::selection{background:var(--accent);color:#fff}
button{cursor:pointer;font-family:inherit;border:none;background:none}
input{font-family:inherit}
.nav{position:sticky;top:0;z-index:1000;height:56px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;background:rgba(8,9,12,0.92);backdrop-filter:blur(24px);border-bottom:1px solid var(--brd)}
.nav-l{display:flex;align-items:center;gap:20px}
.logo{display:flex;align-items:center;gap:8px;cursor:pointer}
.logo i{width:26px;height:26px;background:var(--accent);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff;font-style:normal}
.logo span{font-family:'Fraunces',serif;font-size:19px;font-weight:700;letter-spacing:-0.5px}
.tabs{display:flex;gap:2px}
.tab{padding:5px 11px;font-size:12.5px;font-weight:500;color:var(--td);border-radius:6px;transition:all .15s}
.tab:hover{color:var(--ts);background:var(--el)}
.tab.on{color:var(--text);background:var(--el)}
.nav-r{display:flex;align-items:center;gap:8px}
.btn-a{padding:6px 15px;background:var(--accent);border-radius:6px;color:#fff;font-size:12.5px;font-weight:600;transition:all .15s}
.btn-a:hover{filter:brightness(1.1)}
.user-pill{display:flex;align-items:center;gap:6px;padding:4px 12px 4px 4px;background:var(--el);border:1px solid var(--brd);border-radius:100px;font-size:12px;color:var(--ts);cursor:pointer;transition:all .15s}
.user-pill:hover{border-color:var(--bl);color:var(--text)}
.user-pill .uav{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff}
.umenu{position:absolute;top:52px;right:20px;background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:6px;min-width:180px;display:none;z-index:2000;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
.umenu.show{display:block}
.umenu button{display:block;width:100%;text-align:left;padding:8px 12px;font-size:12.5px;color:var(--ts);border-radius:6px;transition:all .12s}
.umenu button:hover{background:var(--el);color:var(--text)}
.umenu hr{border:none;border-top:1px solid var(--brd);margin:4px 0}
.page{display:none;max-width:920px;margin:0 auto;padding:28px 20px 60px}.page.on{display:block}
h1.hero{font-family:'Fraunces',serif;font-size:32px;font-weight:700;letter-spacing:-1.5px;margin-bottom:4px}
.sub{color:var(--td);font-size:14px;margin-bottom:22px}.sub b{color:var(--accent);font-weight:600}
/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:3000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-bg.show{display:flex}
.modal{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:32px;width:100%;max-width:400px;position:relative}
.modal h2{font-family:'Fraunces',serif;font-size:22px;font-weight:700;margin-bottom:4px}
.modal p.ms{font-size:13px;color:var(--td);margin-bottom:20px}
.modal .close{position:absolute;top:12px;right:16px;font-size:20px;color:var(--td);background:none;border:none;cursor:pointer}
.modal .close:hover{color:var(--text)}
.finput{width:100%;padding:10px 12px;background:var(--el);border:1px solid var(--brd);border-radius:7px;color:var(--text);font-size:13.5px;outline:none;margin-bottom:10px;transition:border-color .15s}
.finput:focus{border-color:var(--accent)}
.finput::placeholder{color:var(--td)}
.fbtn{width:100%;padding:10px;background:var(--accent);border-radius:7px;color:#fff;font-size:13.5px;font-weight:600;border:none;cursor:pointer;margin-top:4px;transition:all .15s}
.fbtn:hover{filter:brightness(1.1)}
.fbtn:disabled{opacity:0.5;cursor:not-allowed}
.flink{font-size:12px;color:var(--td);margin-top:12px;text-align:center}
.flink a{color:var(--accent);cursor:pointer;text-decoration:none}
.flink a:hover{text-decoration:underline}
.ferr{font-size:12px;color:var(--sh);margin-bottom:8px;display:none}
.ferr.show{display:block}
.fok{font-size:12px;color:var(--sl);margin-bottom:8px;display:none}
.fok.show{display:block}
/* DATE PICKER */
.dp{display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap}
.dp-btn{padding:6px 11px;background:var(--card);border:1px solid var(--brd);border-radius:7px;color:var(--td);font-size:13px;font-weight:500;transition:all .15s}
.dp-btn:hover{border-color:var(--bl);color:var(--text)}
.dp select{background:var(--card);border:1px solid var(--brd);border-radius:7px;color:var(--text);padding:6px 10px;font-size:13px;font-family:inherit;outline:none;cursor:pointer;max-width:220px}
.dp-single{font-size:13px;color:var(--ts)}
/* FILTERS */
.fbar{display:flex;gap:6px;margin-bottom:22px;flex-wrap:wrap}
.fc{padding:5px 12px;border-radius:100px;font-size:12px;font-weight:500;background:var(--card);border:1px solid var(--brd);color:var(--td);transition:all .15s;display:flex;align-items:center;gap:6px}
.fc:hover{border-color:var(--bl);color:var(--ts)}
.fc.on{background:var(--accent);border-color:var(--accent);color:#fff}
.fc .dot{width:7px;height:7px;border-radius:50%}
/* CARDS */
.rc{display:flex;gap:14px;padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:11px;margin-bottom:8px;cursor:pointer;transition:all .2s;animation:fi .3s ease both}
.rc:hover{border-color:var(--bl);background:var(--el);transform:translateX(3px)}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.pb{flex-shrink:0;border-radius:8px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.pb::after{content:'';position:absolute;inset:0;border:1px solid rgba(255,255,255,0.06);border-radius:inherit}
.pb.movie{background:linear-gradient(145deg,#312e81,#4338ca)}.pb.tv{background:linear-gradient(145deg,#581c87,#7e22ce)}.pb.book{background:linear-gradient(145deg,#134e4a,#0f766e)}.pb.game{background:linear-gradient(145deg,#881337,#be123c)}.pb.anime{background:linear-gradient(145deg,#831843,#be185d)}.pb.music{background:linear-gradient(145deg,#713f12,#a16207)}.pb.podcast{background:linear-gradient(145deg,#4c1d95,#6d28d9)}.pb.boardgame{background:linear-gradient(145deg,#164e63,#0891b2)}.pb.comic{background:linear-gradient(145deg,#7c2d12,#c2410c)}.pb.news{background:linear-gradient(145deg,#1e293b,#475569)}
.pb img{width:100%;height:100%;object-fit:cover;border-radius:inherit}
.ri{flex:1;min-width:0}
.rt{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:3px}
.rn{font-family:'Fraunces',serif;font-size:16px;font-weight:600;letter-spacing:-0.3px;line-height:1.25}
.mb{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;flex-shrink:0;white-space:nowrap}
.mb.movie{background:rgba(99,102,241,0.15);color:#6366f1}.mb.tv{background:rgba(168,85,247,0.15);color:#a855f7}.mb.book{background:rgba(20,184,166,0.15);color:#14b8a6}.mb.game{background:rgba(244,63,94,0.15);color:#f43f5e}.mb.anime{background:rgba(236,72,153,0.15);color:#ec4899}.mb.music{background:rgba(234,179,8,0.15);color:#eab308}.mb.podcast{background:rgba(139,92,246,0.15);color:#8b5cf6}.mb.boardgame{background:rgba(6,182,212,0.15);color:#06b6d4}.mb.comic{background:rgba(249,115,22,0.15);color:#f97316}.mb.news{background:rgba(100,116,139,0.15);color:#94a3b8}
.rm{font-size:11.5px;color:var(--td);margin-bottom:6px}.rm .s{color:var(--bl);margin:0 4px}
.rs{font-size:12.5px;color:var(--ts);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:8px}
.rf{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:4px}
.gt{display:flex;gap:4px;flex-wrap:wrap}.gt span{padding:2px 6px;background:var(--el);border-radius:4px;font-size:10.5px;color:var(--td)}
.rst{font-size:11px;color:var(--td);display:flex;align-items:center;gap:10px}
.sds{display:inline-flex;gap:2px;align-items:center}.sds i{width:6px;height:6px;border-radius:50%;font-style:normal;display:inline-block}.sds .l{background:var(--sl)}.sds .m{background:var(--sm)}.sds .h{background:var(--sh)}
/* DETAIL */
.dbk{color:var(--td);font-size:13px;padding:4px 0;margin-bottom:18px;display:inline-flex;align-items:center;gap:6px;transition:color .15s}.dbk:hover{color:var(--text)}
.dh{display:flex;gap:24px;margin-bottom:26px}
.dn{font-family:'Fraunces',serif;font-size:28px;font-weight:700;letter-spacing:-1.2px;line-height:1.12;margin:8px 0 6px}
.dd{font-size:14px;color:var(--ts);line-height:1.65;max-width:580px;margin:12px 0 16px}
.da{display:flex;gap:8px;flex-wrap:wrap}
.da button{padding:8px 18px;border-radius:7px;font-size:13px;font-weight:600;transition:all .15s}
.da .p{background:var(--accent);color:#fff;border:none}.da .p:hover{filter:brightness(1.1)}
.da .p.active{background:var(--sl)}
.da .o{background:none;border:1px solid var(--brd);color:var(--ts)}.da .o:hover{border-color:var(--bl);color:var(--text)}
.da .o.active{border-color:var(--sl);color:var(--sl)}
.spb{display:flex;gap:10px;padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:10px;margin-bottom:24px}
.sps{flex:1;text-align:center;padding:10px 8px;border-radius:8px}.sps em{font-size:22px;font-weight:700;font-style:normal;display:block}.sps small{font-size:10px;color:var(--td);text-transform:uppercase;letter-spacing:.8px}
.sps.sl{background:var(--slb)}.sps.sl em{color:var(--sl)}.sps.sm{background:var(--smb)}.sps.sm em{color:var(--sm)}.sps.sv{background:var(--shb)}.sps.sv em{color:var(--sh)}
.st{font-family:'Fraunces',serif;font-size:19px;font-weight:700;margin-bottom:14px}
.cmp{padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:10px;margin-bottom:18px}
.cmp textarea{width:100%;min-height:68px;background:var(--el);border:1px solid var(--brd);border-radius:7px;padding:11px;color:var(--text);font-size:13px;resize:vertical;outline:none;font-family:inherit}
.cmp textarea:focus{border-color:rgba(255,107,53,0.5)}.cmp textarea::placeholder{color:var(--td)}
.cmpf{display:flex;align-items:center;justify-content:space-between;margin-top:9px;flex-wrap:wrap;gap:8px}
.spp{display:flex;gap:4px;align-items:center;flex-wrap:wrap}.spp>span{font-size:11px;color:var(--td);margin-right:3px}
.slb{padding:3px 9px;border-radius:100px;font-size:11px;font-weight:600;transition:all .15s}
.bps{padding:6px 15px;background:var(--accent);border-radius:7px;color:#fff;font-size:12.5px;font-weight:600;transition:opacity .15s}
.bps:disabled{opacity:0.5;cursor:not-allowed}
.cfs{display:flex;gap:4px;margin-bottom:16px;align-items:center;flex-wrap:wrap}.cfs>span{font-size:11px;color:var(--td);margin-right:2px}
.cfb{padding:3px 9px;border-radius:100px;font-size:11px;font-weight:500;background:var(--card);border:1px solid var(--brd);color:var(--td);transition:all .15s}.cfb:hover{color:var(--ts)}.cfb.on{background:var(--el);color:var(--text);border-color:var(--bl)}
.cm{padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:10px;margin-bottom:7px}.cm:hover{border-color:var(--bl)}
.cmh{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px}.cmu{display:flex;align-items:center;gap:8px}
.av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff}
.cmn{font-size:12.5px;font-weight:600}.cmt{font-size:10.5px;color:var(--td)}
.sb{padding:2px 9px;border-radius:100px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.7px}
.cmb{font-size:13.5px;line-height:1.6;color:var(--ts);transition:filter .3s}.cmb.bl{filter:blur(6px);user-select:none}
.rvb{display:flex;align-items:center;justify-content:center;gap:6px;padding:7px;margin-top:7px;background:var(--el);border-radius:7px;cursor:pointer;font-size:12px;font-weight:500;color:var(--td)}.rvb:hover{color:var(--text);background:var(--hov)}
.cmf{display:flex;gap:14px;margin-top:10px;font-size:12px;color:var(--td)}.cmf span{cursor:pointer}.cmf span:hover{color:var(--text)}.cmf span.voted{color:var(--accent)}
.login-prompt{padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:10px;margin-bottom:18px;text-align:center;font-size:13px;color:var(--td)}
.login-prompt a{color:var(--accent);cursor:pointer}
/* TRENDING */
.trc{display:flex;gap:12px;padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:11px;margin-bottom:8px;cursor:pointer;transition:all .15s}
.trc:hover{border-color:var(--bl);background:var(--el)}
.trk{width:32px;height:32px;border-radius:8px;background:var(--agl);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--accent);flex-shrink:0}
.tri{flex:1;min-width:0}.trt{font-family:'Fraunces',serif;font-size:15px;font-weight:600;margin-bottom:2px}.trm{font-size:11.5px;color:var(--td)}
.trd{padding:2px 8px;background:var(--agl);border-radius:100px;font-size:10px;font-weight:700;color:var(--accent);white-space:nowrap}
/* ARCHIVE */
.arcs{display:flex;gap:12px;padding:16px;background:var(--card);border:1px solid var(--brd);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
/* CALENDAR */
.cal{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:16px;margin-bottom:20px}
.cal-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.cal-hd h2{font-family:'Fraunces',serif;font-size:20px;font-weight:700}
.cal-hd button{padding:6px 14px;background:var(--el);border:1px solid var(--brd);border-radius:8px;color:var(--ts);font-size:13px;font-weight:600;transition:all .15s}
.cal-hd button:hover{color:var(--text);border-color:var(--bl)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-dow{text-align:center;font-size:10px;font-weight:600;color:var(--td);text-transform:uppercase;padding:6px 0;letter-spacing:.5px}
.cal-day{min-height:64px;padding:6px;border-radius:8px;background:var(--el);border:1px solid transparent;cursor:default;transition:all .15s;position:relative}
.cal-day.empty{background:transparent;border:none}
.cal-day.has{cursor:pointer;border-color:var(--brd)}
.cal-day.has:hover{border-color:var(--bl);background:var(--hov);transform:translateY(-1px)}
.cal-day.today{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
.cal-day .cd-num{font-size:12px;font-weight:600;margin-bottom:4px}
.cal-day.today .cd-num{color:var(--accent)}
.cal-day .cd-ct{font-size:10px;color:var(--accent);font-weight:700}
.cal-day .cd-dots{display:flex;gap:2px;flex-wrap:wrap;margin-top:2px}
.cal-day .cd-dots span{width:6px;height:6px;border-radius:50%}
.cal-legend{display:flex;gap:12px;flex-wrap:wrap;padding:12px 0;font-size:11px;color:var(--td)}
.cal-legend span{display:flex;align-items:center;gap:4px}
.cal-legend i{width:8px;height:8px;border-radius:50%;display:inline-block}
.arci{flex:1;min-width:80px;text-align:center;padding:8px}.arci em{font-size:24px;font-weight:700;font-style:normal;display:block;color:var(--accent)}.arci small{font-size:10px;color:var(--td);text-transform:uppercase;letter-spacing:.7px}
.arcg{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.arcd{padding:12px;background:var(--card);border:1px solid var(--brd);border-radius:9px;cursor:pointer;transition:all .15s;text-align:center}.arcd:hover{border-color:var(--bl);background:var(--el);transform:translateY(-1px)}.arcd.now{border-color:var(--accent)}
.arcd-dt{font-family:'Fraunces',serif;font-size:14px;font-weight:600;margin-bottom:2px}.arcd-n{font-size:22px;font-weight:700;color:var(--accent)}.arcd-l{font-size:10px;color:var(--td);margin-top:1px}.arcd-t{display:flex;gap:2px;justify-content:center;margin-top:5px}.arcd-t span{font-size:10px}
.sect{font-family:'Fraunces',serif;font-size:17px;font-weight:700;margin-bottom:12px;margin-top:28px}
/* STREAMS */
.shd p{color:var(--td);font-size:14px;margin-bottom:28px;max-width:460px}
.sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:9px}
.sc{padding:16px;background:var(--card);border:1px solid var(--brd);border-radius:10px;transition:all .2s}.sc:hover{border-color:var(--bl);transform:translateY(-2px)}
.sct{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:9px}
.si{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:17px;background:var(--agl)}
.ssb{padding:4px 11px;border-radius:100px;font-size:11px;font-weight:600;border:1px solid var(--brd);color:var(--td);transition:all .15s}.ssb:hover{border-color:var(--accent);color:var(--accent)}.ssb.on{background:var(--accent);border-color:var(--accent);color:#fff}
.sc h3{font-size:13.5px;font-weight:600;margin-bottom:3px}.sc p{font-size:11.5px;color:var(--td);line-height:1.4;margin-bottom:8px}
.scs{display:flex;gap:12px;font-size:11px;color:var(--td)}
.empty{text-align:center;padding:60px 20px;color:var(--td)}.empty h2{font-family:'Fraunces',serif;font-size:22px;color:var(--ts);margin-bottom:8px}
/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:10px 20px;background:var(--card);border:1px solid var(--brd);border-radius:8px;font-size:13px;color:var(--text);z-index:5000;opacity:0;transition:opacity .3s;pointer-events:none}
.toast.show{opacity:1}
/* REPORT */
.rpt-reasons{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.rpt-reasons label{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--el);border:1px solid var(--brd);border-radius:7px;font-size:13px;color:var(--ts);cursor:pointer;transition:all .15s}
.rpt-reasons label:hover{border-color:var(--bl)}
.rpt-reasons input[type=radio]{accent-color:var(--accent)}
.rpt-reasons input[type=radio]:checked+span{color:var(--text)}
/* MOD PANEL */
.mod-bar{display:flex;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid var(--brd)}
.mod-btn{padding:3px 9px;border-radius:5px;font-size:10.5px;font-weight:600;transition:all .15s}
.mod-btn.hide{background:rgba(239,68,68,0.1);color:var(--sh);border:1px solid rgba(239,68,68,0.2)}
.mod-btn.hide:hover{background:rgba(239,68,68,0.2)}
.mod-btn.ban{background:rgba(239,68,68,0.15);color:#ff6b6b;border:1px solid rgba(239,68,68,0.3)}
.mod-btn.ban:hover{background:rgba(239,68,68,0.25)}
.mod-btn.ok{background:rgba(62,201,140,0.1);color:var(--sl);border:1px solid rgba(62,201,140,0.2)}
.mod-btn.ok:hover{background:rgba(62,201,140,0.2)}
.hidden-tag{display:inline-block;padding:2px 7px;background:rgba(239,68,68,0.1);color:var(--sh);border-radius:4px;font-size:10px;font-weight:600;margin-left:6px}
/* MOBILE BOTTOM NAV */
.bnav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:1000;height:60px;background:rgba(8,9,12,0.96);backdrop-filter:blur(24px);border-top:1px solid var(--brd);padding:0 8px;justify-content:space-around;align-items:center}
.bnav button{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;background:none;border:none;color:var(--td);font-size:9.5px;font-weight:500;transition:all .15s;border-radius:8px}
.bnav button .bi{font-size:18px;line-height:1}
.bnav button.on{color:var(--accent)}
.bnav button.on .bi{transform:scale(1.1)}
/* DESIGN POLISH */
.rc{background:var(--card);border:1px solid var(--brd);border-radius:12px;overflow:hidden;transition:all .25s ease}
.rc:hover{border-color:var(--bl);background:var(--el);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.2)}
.pb{border-radius:9px;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.rn{font-size:15.5px;line-height:1.3}
.fc{backdrop-filter:blur(8px)}
.fc.on{box-shadow:0 2px 8px rgba(255,107,53,0.25)}
.cm{border-radius:12px;transition:all .2s}
.trc{border-radius:12px}
.sc{border-radius:12px}
.modal{border-radius:16px;box-shadow:0 24px 48px rgba(0,0,0,0.4)}
.toast{border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.dp select{border-radius:8px}
.dp-btn{border-radius:8px}
/* POSTER HOVER */
.rc .pb img{transition:transform .3s ease}
.rc:hover .pb img{transform:scale(1.04)}
/* ACCENT GLOW */
.btn-a{box-shadow:0 2px 8px rgba(255,107,53,0.2)}
.btn-a:hover{box-shadow:0 4px 16px rgba(255,107,53,0.35)}
/* DETAIL PAGE POLISH */
.dh{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:20px;margin-bottom:22px}
.da button{border-radius:8px}
.spb{border-radius:12px}
/* SCROLL BAR */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bl);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--td)}
/* RESPONSIVE */
@media(max-width:640px){
  .nav{padding:0 12px;height:50px}
  .tabs{display:none}
  .bnav{display:flex}
  .page{padding:14px 12px 80px}
  h1.hero{font-size:24px}
  .sub{font-size:13px;margin-bottom:16px}
  .dh{flex-direction:column;gap:14px;padding:14px}
  .dh .pb{align-self:center}
  .dn{font-size:22px}
  .dd{font-size:13px}
  .sg{grid-template-columns:1fr}
  .rc{gap:10px;padding:12px;border-radius:10px}
  .rn{font-size:14.5px}
  .rs{font-size:12px}
  .rm{font-size:11px}
  .arcg{grid-template-columns:repeat(auto-fill,minmax(95px,1fr))}
  .fbar{gap:5px;margin-bottom:16px}
  .fc{padding:4px 10px;font-size:11.5px}
  .dp{gap:6px}
  .dp select{font-size:12px;padding:5px 8px}
  .modal{margin:12px;padding:24px}
  .cmp{padding:12px}
  .cm{padding:12px}
  .da{gap:6px}
  .da button{padding:7px 14px;font-size:12px}
  .spb{gap:6px;padding:10px}
  .sps{padding:8px 4px}
  .sps em{font-size:18px}
  .arcs{gap:6px;padding:12px}
  .arci em{font-size:20px}
  .trc{gap:10px;padding:12px}
  .trk{width:28px;height:28px;font-size:12px}
  .user-pill{font-size:11px;padding:3px 10px 3px 3px}
  .user-pill .uav{width:22px;height:22px;font-size:9px}
}
@media(max-width:380px){
  .da{flex-direction:column}
  .da button{width:100%;text-align:center}
}
</style>
</head>
<body>
<nav class="nav">
  <div class="nav-l">
    <div class="logo" onclick="go('feed')"><i>U</i><span>unreeled</span></div>
    <div class="tabs">
      <button class="tab on" data-p="feed" onclick="go('feed')">Releases</button>
      <button class="tab" data-p="trending" onclick="go('trending')">Trending</button>
      <button class="tab" data-p="archive" onclick="go('archive')">Archive</button>
      <button class="tab" data-p="calendar" onclick="go('calendar')">Calendar</button>
      <button class="tab" data-p="streams" onclick="go('streams')">Streams</button>
    </div>
  </div>
  <div class="nav-r"><button class="theme-btn" id="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">&#127769;</button><span id="nav-r"></span></div>
</nav>
<div class="umenu" id="umenu"></div>
<!-- AUTH MODAL -->
<div class="modal-bg" id="auth-modal" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="auth-box"></div>
</div>
<div class="toast" id="toast"></div>
<!-- REPORT MODAL -->
<div class="modal-bg" id="report-modal" onclick="if(event.target===this)document.getElementById('report-modal').classList.remove('show')">
  <div class="modal" id="report-box"></div>
</div>
<div id="p-feed" class="page on"></div>
<div id="p-detail" class="page"></div>
<div id="p-trending" class="page"></div>
<div id="p-archive" class="page"></div>
<div id="p-calendar" class="page"></div>
<div id="p-streams" class="page"></div>
<div id="p-account" class="page"></div>
<!-- MOBILE BOTTOM NAV -->
<nav class="bnav" id="bnav">
  <button class="on" data-p="feed" onclick="go('feed')"><span class="bi">&#127916;</span>Releases</button>
  <button data-p="trending" onclick="go('trending')"><span class="bi">&#128293;</span>Trending</button>
  <button data-p="calendar" onclick="go('calendar')"><span class="bi">&#128197;</span>Calendar</button>
  <button data-p="streams" onclick="go('streams')"><span class="bi">&#128225;</span>Streams</button>
  <button data-p="account" onclick="user?go('account'):showAuth('login')"><span class="bi">&#128100;</span>Account</button>
</nav>

<script>
// ═══════ SUPABASE ═══════
const SB_URL='https://zqxivnhfvhgphuqmahkg.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxeGl2bmhmdmhncGh1cW1haGtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMTA5OTQsImV4cCI6MjA4Nzc4Njk5NH0.GlgESEQPREYYJ5dglOLSi5NOGDEnINOJU8VpKrfSiLw';
let sb,user=null,profile=null,userSubs=[],userWatchlist=[];

// ═══════ DATA ═══════
const D=__RELEASE_DATA_PLACEHOLDER__;
const MC={movie:{i:"\uD83C\uDFAC",l:"Film",c:"#6366f1"},tv:{i:"\uD83D\uDCFA",l:"TV",c:"#a855f7"},book:{i:"\uD83D\uDCD6",l:"Book",c:"#14b8a6"},game:{i:"\uD83C\uDFAE",l:"Game",c:"#f43f5e"},anime:{i:"\uD83C\uDF8C",l:"Anime",c:"#ec4899"},music:{i:"\uD83C\uDFB5",l:"Music",c:"#eab308"},podcast:{i:"\uD83C\uDF99",l:"Podcast",c:"#8b5cf6"},boardgame:{i:"\uD83C\uDFB2",l:"Board Game",c:"#06b6d4"},news:{i:"\uD83D\uDCF0",l:"News",c:"#64748b"}};
const SP={none:{l:"No Spoilers",bg:"var(--el)",c:"var(--td)",b:"var(--brd)"},light:{l:"\uD83D\uDFE2 Light",bg:"var(--slb)",c:"var(--sl)",b:"var(--slr)"},medium:{l:"\uD83D\uDFE1 Medium",bg:"var(--smb)",c:"var(--sm)",b:"var(--smr)"},heavy:{l:"\uD83D\uDD34 Heavy",bg:"var(--shb)",c:"var(--sh)",b:"var(--shr)"}};
const STM=[{t:"Platforms & Studios",items:[{n:"A24 Releases",i:"\uD83C\uDFAC",d:"Every A24 theatrical and streaming release",f:"~8/mo"},{n:"HBO Originals",i:"\uD83D\uDCFA",d:"New episodes and premieres across HBO",f:"~15/mo"},{n:"Crunchyroll Simulcasts",i:"\uD83C\uDF8C",d:"Every new simulcast episode as it airs",f:"~40/mo"},{n:"Netflix Originals",i:"\uD83D\uDCFA",d:"Every Netflix original film and series",f:"~30/mo"},{n:"PlayStation Exclusives",i:"\uD83C\uDFAE",d:"First-party and exclusive PS5 launches",f:"~4/mo"},{n:"Tor Books",i:"\uD83D\uDCD6",d:"New fantasy and sci-fi from Tor",f:"~12/mo"},{n:"Napalm Records",i:"\uD83C\uDFB5",d:"New metal and rock from Napalm",f:"~10/mo"}]},{t:"Genres",items:[{n:"Horror (All Media)",i:"\uD83D\uDD2A",d:"Horror across all media types",f:"~18/mo"},{n:"Sci-Fi (All Media)",i:"\uD83D\uDE80",d:"Science fiction across all media",f:"~20/mo"},{n:"Fantasy (All Media)",i:"\u2694\uFE0F",d:"Fantasy across all media types",f:"~22/mo"},{n:"New Vinyl",i:"\uD83C\uDFB5",d:"Latest vinyl pressings across genres",f:"~15/mo"}]},{t:"Series & Franchises",items:[{n:"Golden Kamuy",i:"\uD83C\uDF8C",d:"Final season and manga releases",f:"Weekly"},{n:"My Hero Academia",i:"\uD83C\uDF8C",d:"Main series, Vigilantes, spin-offs",f:"Weekly+"},{n:"Fate Series",i:"\uD83C\uDF8C",d:"All Fate anime, movies, games",f:"Varies"}]}];

let cf="all",cr=null,ccf="all",rv=new Set(),curPage="feed",selSpoiler="none";
let vd=D.latest_date||"",R=(D.latest?D.latest.releases:D.releases)||[];
const dates=D.dates_available||[vd];

// ═══════ TOAST ═══════
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}

// ═══════ THEME ═══════
function toggleTheme(){
  const html=document.documentElement;
  const cur=html.getAttribute('data-theme');
  const next=cur==='dark'?'light':'dark';
  html.setAttribute('data-theme',next);
  localStorage.setItem('unreeled-theme',next);
  document.getElementById('theme-toggle').innerHTML=next==='dark'?'\uD83C\uDF19':'\u2600\uFE0F';
}
(function(){const saved=localStorage.getItem('unreeled-theme');if(saved){document.documentElement.setAttribute('data-theme',saved);setTimeout(()=>{const b=document.getElementById('theme-toggle');if(b)b.innerHTML=saved==='dark'?'\uD83C\uDF19':'\u2600\uFE0F'},0)}})();

// ═══════ SKELETON ═══════
function showSkeleton(el,count){let h='';for(let i=0;i<(count||5);i++)h+='<div class="skel skel-card" style="animation-delay:'+(i*0.1)+'s"></div>';el.innerHTML=h}

// ═══════ RATINGS ═══════
async function rateRelease(rk,stars){
  if(!user)return showAuth('login');
  const{data,error}=await sb.from('ratings').upsert({user_id:user.id,release_key:rk,rating:stars},{onConflict:'user_id,release_key'}).select().single();
  if(error){console.error('Rating error:',error);toast('Error saving rating');return}
  toast('Rated '+stars+' star'+(stars!==1?'s':'')+'!');
  loadRating(rk);
}
async function loadRating(rk){
  try{
    const{data}=await sb.from('ratings').select('rating').eq('release_key',rk);
    const ratings=data||[];
    const avg=ratings.length?ratings.reduce((s,r)=>s+r.rating,0)/ratings.length:0;
    const myR=user?ratings.find(r=>r.user_id===user?.id):null;
    const el=document.getElementById('rating-display');
    if(!el)return;
    let h='<div class="stars" id="star-row">';
    for(let i=1;i<=5;i++){h+='<span class="'+(myR&&myR.rating>=i?'on':'')+'" onclick="rateRelease(\''+rk+'\','+i+')">\u2605</span>'}
    h+='</div>';
    if(ratings.length)h+='<span class="avg-rating"><em>'+avg.toFixed(1)+'</em> ('+ratings.length+')</span>';
    else h+='<span class="avg-rating">No ratings yet</span>';
    el.innerHTML=h;
  }catch(e){console.error('Load rating error:',e)}
}

// ═══════ NAV ═══════
function go(p,push){document.querySelectorAll('.page').forEach(x=>x.classList.remove('on'));document.getElementById('p-'+p).classList.add('on');document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));document.querySelector('.tab[data-p="'+(p==='detail'||p==='account'?'feed':p)+'"]')?.classList.add('on');document.querySelectorAll('.bnav button').forEach(b=>b.classList.remove('on'));const bp=p==='detail'?'feed':p;document.querySelector('.bnav button[data-p="'+bp+'"]')?.classList.add('on');if(push!==false&&p!==curPage)history.pushState({page:p},'','');curPage=p;window.scrollTo({top:0,behavior:'smooth'});document.getElementById('umenu').classList.remove('show')}
window.addEventListener('popstate',e=>{go((e.state&&e.state.page)||'feed',false)});

function renderNav(){
  const el=document.getElementById('nav-r');
  if(user&&profile){
    const init=profile.username.slice(0,2).toUpperCase();
    el.innerHTML='<div class="user-pill" onclick="document.getElementById(\'umenu\').classList.toggle(\'show\')"><div class="uav" style="background:'+profile.avatar_color+'">'+init+'</div>'+esc(profile.username)+'</div>';
    document.getElementById('umenu').innerHTML='<button onclick="go(\'account\')">My Account</button><button onclick="go(\'streams\')">My Streams</button><hr><button onclick="doLogout()">Log Out</button>';
  } else {
    el.innerHTML='<button class="btn-a" onclick="showAuth(\'signup\')">Sign Up</button><button style="font-size:12.5px;color:var(--td);padding:6px 10px" onclick="showAuth(\'login\')">Log In</button>';
    document.getElementById('umenu').classList.remove('show');
  }
}

// ═══════ AUTH MODAL ═══════
function showAuth(mode){
  const box=document.getElementById('auth-box');
  if(mode==='signup'){
    box.innerHTML='<button class="close" onclick="closeModal()">\u2715</button><h2>Create Account</h2><p class="ms">Join Unreeled to comment, subscribe, and track releases.</p><div class="ferr" id="aerr"></div><div class="fok" id="aok"></div><input class="finput" id="a-user" placeholder="Username (3-20 chars)" maxlength="20"><input class="finput" id="a-email" placeholder="Email" type="email"><input class="finput" id="a-pass" placeholder="Password (min 6 chars)" type="password"><button class="fbtn" id="a-btn" onclick="doSignup()">Create Account</button><p class="flink">Already have an account? <a onclick="showAuth(\'login\')">Log in</a></p>';
  } else if(mode==='login'){
    box.innerHTML='<button class="close" onclick="closeModal()">\u2715</button><h2>Welcome Back</h2><p class="ms">Log in to your Unreeled account.</p><div class="ferr" id="aerr"></div><input class="finput" id="a-email" placeholder="Email" type="email"><input class="finput" id="a-pass" placeholder="Password" type="password"><button class="fbtn" id="a-btn" onclick="doLogin()">Log In</button><p class="flink"><a onclick="showAuth(\'forgot\')">Forgot password?</a> \u00B7 <a onclick="showAuth(\'signup\')">Create account</a></p>';
  } else if(mode==='forgot'){
    box.innerHTML='<button class="close" onclick="closeModal()">\u2715</button><h2>Reset Password</h2><p class="ms">Enter your email and we\'ll send a reset link.</p><div class="ferr" id="aerr"></div><div class="fok" id="aok"></div><input class="finput" id="a-email" placeholder="Email" type="email"><button class="fbtn" onclick="doReset()">Send Reset Link</button><p class="flink"><a onclick="showAuth(\'login\')">Back to login</a></p>';
  }
  document.getElementById('auth-modal').classList.add('show');
}
function closeModal(){document.getElementById('auth-modal').classList.remove('show')}
function showErr(msg){const e=document.getElementById('aerr');if(e){e.textContent=msg;e.classList.add('show')}}
function showOk(msg){const e=document.getElementById('aok');if(e){e.textContent=msg;e.classList.add('show')}}

async function doSignup(){
  const un=document.getElementById('a-user').value.trim();
  const em=document.getElementById('a-email').value.trim();
  const pw=document.getElementById('a-pass').value;
  if(!un||un.length<3)return showErr('Username must be at least 3 characters');
  if(!/^[a-zA-Z0-9_]+$/.test(un))return showErr('Username: letters, numbers, underscores only');
  if(!em)return showErr('Email is required');
  if(pw.length<6)return showErr('Password must be at least 6 characters');
  document.getElementById('a-btn').disabled=true;
  const{data,error}=await sb.auth.signUp({email:em,password:pw,options:{data:{username:un,display_name:un}}});
  document.getElementById('a-btn').disabled=false;
  if(error)return showErr(error.message);
  if(data.user&&!data.session){showOk('Check your email to confirm your account!');return}
  closeModal();toast('Welcome to Unreeled, '+un+'!');await loadUser();renderNav();renderFeed();
}

async function doLogin(){
  const em=document.getElementById('a-email').value.trim();
  const pw=document.getElementById('a-pass').value;
  if(!em||!pw)return showErr('Email and password required');
  document.getElementById('a-btn').disabled=true;
  const{error}=await sb.auth.signInWithPassword({email:em,password:pw});
  document.getElementById('a-btn').disabled=false;
  if(error)return showErr(error.message);
  closeModal();toast('Welcome back!');await loadUser();renderNav();renderFeed();
}

async function doReset(){
  const em=document.getElementById('a-email').value.trim();
  if(!em)return showErr('Email is required');
  const{error}=await sb.auth.resetPasswordForEmail(em,{redirectTo:'https://keenestza.github.io/unreeled/'});
  if(error)return showErr(error.message);
  showOk('Reset link sent! Check your email.');
}

async function doLogout(){
  await sb.auth.signOut();user=null;profile=null;userSubs=[];userWatchlist=[];
  renderNav();renderFeed();toast('Logged out');
}

// ═══════ USER DATA ═══════
async function loadUser(){
  const{data}=await sb.auth.getUser();
  user=data.user;
  if(!user)return;
  const{data:p}=await sb.from('profiles').select('*').eq('id',user.id).single();
  profile=p;
  const{data:s}=await sb.from('subscriptions').select('*').eq('user_id',user.id);
  userSubs=s||[];
  const{data:w}=await sb.from('watchlist').select('*').eq('user_id',user.id);
  userWatchlist=w||[];
}

function isSubbed(type,value){return userSubs.some(s=>s.subscription_type===type&&s.subscription_value===value)}
function isWatchlisted(key){return userWatchlist.some(w=>w.release_key===key)}
function releaseKey(r){return vd+':'+r.media_type+':'+(r.title||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').slice(0,80)}
function isAdmin(){return profile&&(profile.role==='admin'||profile.role==='moderator')}

// ═══════ HELPERS ═══════
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function meta(r){const m=r.metadata||{},p=[];if(r.media_type==='movie'){if(m.runtime_minutes)p.push(m.runtime_minutes+' min');if(m.original_language)p.push(m.original_language.toUpperCase());if(m.ratings?.rotten_tomatoes)p.push('\uD83C\uDF45 '+m.ratings.rotten_tomatoes);if(m.ratings?.metacritic)p.push('MC: '+m.ratings.metacritic)}if(r.media_type==='tv'){if(m.networks?.length)p.push(m.networks[0]);if(m.ratings?.rotten_tomatoes)p.push('\uD83C\uDF45 '+m.ratings.rotten_tomatoes)}if(r.media_type==='game'&&m.platforms?.length)p.push(m.platforms[0]);if(r.media_type==='anime'){if(m.studios?.length)p.push(m.studios[0]);if(m.score)p.push('\u2605 '+m.score)}if(r.media_type==='book'){if(m.authors?.length)p.push(m.authors[0]);if(m.publisher)p.push(m.publisher);if(m.page_count)p.push(m.page_count+'pp')}if(r.media_type==='music'){if(m.artists?.length)p.push(m.artists[0]);if(m.formats?.length)p.push(m.formats.join(', '));if(m.labels?.length&&m.labels[0]!=='[no label]')p.push(m.labels[0]);if(m.track_count)p.push(m.track_count+' tracks')}if(r.media_type==='podcast'){if(m.author)p.push(m.author);if(m.episode_count)p.push(m.episode_count+' eps')}if(r.media_type==='boardgame'){if(m.players)p.push(m.players+' players');if(m.playtime_minutes)p.push(m.playtime_minutes+' min')}if(r.media_type==='comic'){if(m.volume)p.push(m.volume);if(m.publisher)p.push(m.publisher)}if(r.media_type==='news'){if(m.source_name)p.push(m.source_name)}if(m.streaming){const sn=Object.keys(m.streaming).slice(0,3);if(sn.length)p.push('\uD83D\uDCFA '+sn.join(', '))}return p.join('<span class="s">\u00B7</span>')}
function poster(r,w,h,fs){const t=r.media_type,c=MC[t]||MC.movie;if(r.poster_url)return'<div class="pb '+t+'" style="width:'+w+'px;height:'+h+'px"><img src="'+esc(r.poster_url)+'" alt="" loading="lazy" onerror="this.parentElement.innerHTML=\''+c.i+'\';this.remove()"></div>';return'<div class="pb '+t+'" style="width:'+w+'px;height:'+h+'px;font-size:'+fs+'px">'+c.i+'</div>'}
function fmtD(d){try{return new Date(d+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})}catch(e){return d}}
function dayN(d){try{return new Date(d+'T12:00:00').toLocaleDateString('en-US',{weekday:'long'})}catch(e){return''}}
function timeAgo(ts){const s=Math.floor((Date.now()-new Date(ts))/1000);if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago'}
function loadDate(d){vd=d;R=(D.historical&&D.historical[d])?D.historical[d]:(D.latest&&D.latest.date===d)?D.latest.releases:[];cf="all";renderFeed()}
function card(r,i,oc){const c=MC[r.media_type]||MC.movie,sp=r.spoiler_counts||{},hs=(sp.light||0)+(sp.medium||0)+(sp.heavy||0)>0;let dots='';if(hs){dots='<span class="sds">';if(sp.light)dots+='<i class="l"></i>';if(sp.medium)dots+='<i class="m"></i>';if(sp.heavy)dots+='<i class="h"></i>';dots+='</span> Spoilers'}const gt=(r.genres||[]).slice(0,3).map(g=>'<span>'+esc(g)+'</span>').join('');const isNew=r.release_date===D.latest_date;const nbadge=isNew?'<span class="new-badge">New</span>':'';return'<div class="rc" onclick="'+oc+'" style="animation-delay:'+Math.min(i*.03,.3)+'s">'+poster(r,68,95,24)+'<div class="ri"><div class="rt"><div class="rn">'+esc(r.title)+nbadge+'</div><span class="mb '+r.media_type+'">'+c.l+'</span></div><div class="rm">'+meta(r)+'</div>'+(r.synopsis?'<p class="rs">'+esc(r.synopsis)+'</p>':'')+'<div class="rf"><div class="gt">'+gt+'</div><div class="rst"><span>\uD83D\uDCAC '+(r.comment_count||0)+'</span>'+(hs?'<span>'+dots+'</span>':'')+'</div></div></div></div>'}

// ═══════ FEED ═══════
let searchQ='',sortBy='popularity',feedPage=0,feedFiltered=[],FEED_PAGE_SIZE=30,feedObserver=null,globalSearch=false;

function getFilteredFeed(){
  const cn={};R.forEach(r=>cn[r.media_type]=(cn[r.media_type]||0)+1);
  let baseList=R;
  // Global search: combine all dates
  if(globalSearch&&searchQ&&D.historical){
    baseList=[];
    for(const d of dates){
      const dayReleases=D.historical[d]||[];
      dayReleases.forEach(r=>{r._fromDate=d;baseList.push(r)});
    }
    // Recount with full set
    baseList.forEach(r=>cn[r.media_type]=(cn[r.media_type]||0)+1);
  }
  let fl=cf==='all'?baseList:baseList.filter(r=>r.media_type===cf);
  if(searchQ){const q=searchQ.toLowerCase();fl=fl.filter(r=>(r.title||'').toLowerCase().includes(q)||(r.synopsis||'').toLowerCase().includes(q)||(r.genres||[]).some(g=>g.toLowerCase().includes(q))||(r.metadata?.artists||[]).some(a=>a.toLowerCase().includes(q))||(r.metadata?.authors||[]).some(a=>a.toLowerCase().includes(q))||(r.metadata?.networks||[]).some(n=>n.toLowerCase().includes(q))||(r.metadata?.studios||[]).some(s=>s.toLowerCase().includes(q)))}
  fl=[...fl].sort((a,b)=>{
    if(sortBy==='alpha')return(a.title||'').localeCompare(b.title||'');
    if(sortBy==='alpha-z')return(b.title||'').localeCompare(a.title||'');
    if(sortBy==='type')return(a.media_type||'').localeCompare(b.media_type||'');
    return((b.metadata||{}).popularity||0)-((a.metadata||{}).popularity||0);
  });
  return{fl,cn};
}

function renderFeed(){
  feedPage=0;
  const{fl,cn}=getFilteredFeed();
  feedFiltered=fl;
  const isL=vd===D.latest_date;
  let h='<h1 class="hero">'+(isL?'Today in Media':'Releases')+'</h1>';
  h+='<div class="dp">';const ci=dates.indexOf(vd);
  if(ci<dates.length-1)h+='<button class="dp-btn" onclick="loadDate(\''+dates[ci+1]+'\')">\u2190</button>';
  if(dates.length>1){h+='<select onchange="loadDate(this.value)">';dates.forEach(d=>{h+='<option value="'+d+'"'+(d===vd?' selected':'')+'>'+fmtD(d)+(d===D.latest_date?' (latest)':'')+'</option>'});h+='</select>'}else{h+='<span class="dp-single">'+fmtD(vd)+'</span>'}
  if(ci>0)h+='<button class="dp-btn" onclick="loadDate(\''+dates[ci-1]+'\')">\u2192</button>';
  h+='</div><p class="sub">'+dayN(vd)+' \u2014 <b>'+R.length+' releases</b></p>';
  // Search bar
  h+='<div style="display:flex;gap:8px;margin-bottom:14px;align-items:center;flex-wrap:wrap"><div style="flex:1;min-width:180px;position:relative"><input class="finput" id="search-box" type="text" placeholder="\uD83D\uDD0D Search releases..." value="'+esc(searchQ)+'" style="margin:0;padding-left:12px;padding-right:32px" oninput="searchQ=this.value;renderFeed()"><span onclick="searchQ=\'\';renderFeed()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--td);font-size:14px;display:'+(searchQ?'block':'none')+'">\u2715</span></div><select class="finput" style="width:auto;margin:0;min-width:130px" onchange="sortBy=this.value;renderFeed()"><option value="popularity"'+(sortBy==='popularity'?' selected':'')+'>Popular first</option><option value="alpha"'+(sortBy==='alpha'?' selected':'')+'>A \u2192 Z</option><option value="alpha-z"'+(sortBy==='alpha-z'?' selected':'')+'>Z \u2192 A</option><option value="type"'+(sortBy==='type'?' selected':'')+'>By type</option></select><label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--td);cursor:pointer;white-space:nowrap"><input type="checkbox" id="global-search" '+(globalSearch?'checked':'')+' onchange="globalSearch=this.checked;renderFeed()" style="accent-color:var(--accent)">All dates</label></div>';
  // Filter bar
  h+='<div class="fbar"><button class="fc '+(cf==='all'?'on':'')+'" onclick="cf=\'all\';renderFeed()">All ('+R.length+')</button>';
  for(const[t,c]of Object.entries(MC)){if(cn[t]){const dot=cf!==t?'<span class="dot" style="background:'+c.c+'"></span>':'';h+='<button class="fc '+(cf===t?'on':'')+'" onclick="cf=\''+t+'\';renderFeed()">'+dot+c.l+' ('+cn[t]+')</button>'}}
  h+='</div>';
  if(searchQ)h+='<p style="font-size:12px;color:var(--td);margin-bottom:12px">Showing '+fl.length+' result'+(fl.length!==1?'s':'')+' for "'+esc(searchQ)+'"</p>';
  if(!fl.length)h+='<div class="empty"><span class="empty-icon">'+(searchQ?'\uD83D\uDD0D':'\uD83C\uDFAC')+'</span><h2>'+(searchQ?'No matches found':'No releases today')+'</h2><p>'+(searchQ?'Try a different search term or clear your filters.':'Try a different filter or browse another date.')+'</p></div>';
  // Render first page
  const page=fl.slice(0,FEED_PAGE_SIZE);
  h+='<div id="feed-cards">';
  page.forEach((r,i)=>{const ri=R.indexOf(r);h+=card(r,i,'openD('+ri+')')});
  h+='</div>';
  if(fl.length>FEED_PAGE_SIZE){
    h+='<div id="feed-sentinel" style="padding:24px;text-align:center"><div style="display:inline-block;width:24px;height:24px;border:2px solid var(--brd);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite"></div><p style="font-size:12px;color:var(--td);margin-top:8px">Loading more...</p></div>';
    h+='<style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
  }
  document.getElementById('p-feed').innerHTML=h;
  feedPage=1;
  // Setup infinite scroll observer
  setupFeedObserver();
  // Restore focus to search box if searching
  if(searchQ){const sb=document.getElementById('search-box');if(sb){sb.focus();sb.setSelectionRange(sb.value.length,sb.value.length)}}
}

function loadMoreFeed(){
  const start=feedPage*FEED_PAGE_SIZE;
  const end=start+FEED_PAGE_SIZE;
  const page=feedFiltered.slice(start,end);
  if(!page.length)return;
  const container=document.getElementById('feed-cards');
  if(!container)return;
  let h='';
  page.forEach((r,i)=>{const ri=R.indexOf(r);h+=card(r,start+i,'openD('+ri+')')});
  container.insertAdjacentHTML('beforeend',h);
  feedPage++;
  // Remove sentinel if no more pages
  if(end>=feedFiltered.length){
    const sentinel=document.getElementById('feed-sentinel');
    if(sentinel)sentinel.remove();
    if(feedObserver)feedObserver.disconnect();
  }
}

function setupFeedObserver(){
  if(feedObserver)feedObserver.disconnect();
  const sentinel=document.getElementById('feed-sentinel');
  if(!sentinel)return;
  feedObserver=new IntersectionObserver(entries=>{
    if(entries[0].isIntersecting)loadMoreFeed();
  },{rootMargin:'200px'});
  feedObserver.observe(sentinel);
}

// ═══════ DETAIL ═══════
let detailComments=[];
async function openD(i){
  cr=R[i];rv=new Set();ccf='all';selSpoiler='none';
  const r=cr,c=MC[r.media_type]||MC.movie,sp=r.spoiler_counts||{};
  const rk=releaseKey(r);
  const wl=isWatchlisted(rk);
  const subbed=user&&isSubbed('media_type',r.media_type);

  let h='<button class="dbk" onclick="go(\'feed\')">\u2190 Back</button><div class="dh">'+poster(r,150,210,48)+'<div style="flex:1"><span class="mb '+r.media_type+'">'+c.l+'</span><h1 class="dn">'+esc(r.title)+'</h1><div class="rm">'+meta(r)+(r.genres?.length?'<span class="s">\u00B7</span>'+r.genres.map(esc).join(', '):'')+'</div>'+(r.synopsis?'<p class="dd">'+esc(r.synopsis)+'</p>':'')+'<div class="da"><button class="p'+(subbed?' active':'')+'" onclick="toggleSub(\'media_type\',\''+r.media_type+'\')">\uD83D\uDCE1 '+(subbed?'Following '+c.l:'Follow '+c.l)+'</button><button class="o" onclick="shareRelease()">\uD83D\uDD17 Share</button><button class="o'+(wl?' active':'')+'" onclick="toggleWL()" id="wl-btn">'+(wl?'\u2705 Watchlisted':'\u2B50 Watchlist')+'</button></div></div></div>';
  h+='<div class="spb"><div class="sps sl"><em>'+(sp.light||0)+'</em><small>Light</small></div><div class="sps sm"><em>'+(sp.medium||0)+'</em><small>Medium</small></div><div class="sps sv"><em>'+(sp.heavy||0)+'</em><small>Heavy</small></div></div>';

  // Streaming availability
  const strm=(r.metadata||{}).streaming;
  if(strm&&Object.keys(strm).length){
    h+='<div style="padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:12px;margin-bottom:16px"><div style="font-size:13px;font-weight:600;margin-bottom:8px">\uD83D\uDCFA Where to Watch</div><div style="display:flex;gap:6px;flex-wrap:wrap">';
    for(const[name,info]of Object.entries(strm)){
      const badge=info.type==='sub'?'var(--slb)':info.type==='rent'?'var(--smb)':'var(--el)';
      const lbl=info.type==='sub'?'Stream':info.type==='rent'?'Rent':info.type==='buy'?'Buy':'Watch';
      h+='<a '+(info.url?'href="'+esc(info.url)+'" target="_blank"':'')+'style="display:inline-flex;align-items:center;gap:4px;padding:5px 10px;background:'+badge+';border:1px solid var(--brd);border-radius:6px;font-size:11.5px;color:var(--text);text-decoration:none;transition:all .15s"><span style="font-size:10px;color:var(--td)">'+lbl+'</span> '+esc(name)+'</a>'}
    h+='</div></div>'}

  // Recommendations
  const recs=(r.metadata||{}).recommendations;
  if(recs&&recs.length){
    h+='<div style="padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:12px;margin-bottom:16px"><div style="font-size:13px;font-weight:600;margin-bottom:8px">\u2728 If you liked this</div><div style="display:flex;gap:6px;flex-wrap:wrap">';
    recs.forEach(t=>{h+='<span style="padding:4px 10px;background:var(--el);border:1px solid var(--brd);border-radius:6px;font-size:12px;color:var(--ts)">'+esc(t)+'</span>'});
    h+='</div></div>'}

  // News link
  if(r.media_type==='news'&&(r.metadata||{}).link){
    h+='<div style="margin-bottom:16px"><a href="'+esc(r.metadata.link)+'" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:var(--el);border:1px solid var(--brd);border-radius:8px;color:var(--accent);font-size:13px;font-weight:600;text-decoration:none">\uD83D\uDD17 Read Full Article \u2192</a></div>'}

  // User rating
  h+='<div style="padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:12px;margin-bottom:16px"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-size:13px;font-weight:600">\u2B50 Rate this</div><div id="rating-display"><span class="avg-rating">Loading...</span></div></div></div>';

  // Related releases (same genre)
  const related=findRelated(r,6);
  if(related.length){
    h+='<div style="padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:12px;margin-bottom:16px"><div style="font-size:13px;font-weight:600;margin-bottom:10px">\uD83C\uDFAF Similar Releases</div><div style="display:flex;gap:8px;overflow-x:auto;padding-bottom:4px">';
    related.forEach(rel=>{
      const rc=MC[rel.media_type]||MC.movie;
      const ri=R.indexOf(rel);
      h+='<div onclick="openD('+ri+')" style="flex-shrink:0;width:100px;cursor:pointer;text-align:center"><div style="width:100px;height:140px;border-radius:8px;overflow:hidden;margin-bottom:6px">'+(rel.poster_url?'<img src="'+esc(rel.poster_url)+'" style="width:100%;height:100%;object-fit:cover">':'<div style="width:100%;height:100%;background:'+rc.c+'22;display:flex;align-items:center;justify-content:center;font-size:28px">'+rc.i+'</div>')+'</div><div style="font-size:11px;font-weight:600;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(rel.title)+'</div><div style="font-size:10px;color:var(--td)">'+rc.l+'</div></div>';
    });
    h+='</div></div>';
  }

  h+='<div class="st" id="cmt-count">Discussion</div>';

  // Composer
  if(user){
    h+='<div class="cmp"><textarea id="cmt-body" placeholder="Share your thoughts... Tag your spoiler level below."></textarea><div class="cmpf"><div class="spp"><span>Spoiler level:</span><button class="slb sl-none" data-sl="none" style="border:1px solid var(--brd);color:var(--td);background:var(--el)" onclick="pickSp(this)">No Spoilers</button><button class="slb" data-sl="light" style="border:1px solid var(--slr);color:var(--sl)" onclick="pickSp(this)">\uD83D\uDFE2 Light</button><button class="slb" data-sl="medium" style="border:1px solid var(--smr);color:var(--sm)" onclick="pickSp(this)">\uD83D\uDFE1 Medium</button><button class="slb" data-sl="heavy" style="border:1px solid var(--shr);color:var(--sh)" onclick="pickSp(this)">\uD83D\uDD34 Heavy</button></div><button class="bps" id="post-btn" onclick="postComment()">Post</button></div></div>';
  } else {
    h+='<div class="login-prompt"><a onclick="showAuth(\'signup\')">Sign up</a> or <a onclick="showAuth(\'login\')">log in</a> to join the discussion</div>';
  }
  h+='<div class="cfs"><span>Show:</span><button class="cfb on" onclick="fCmt(\'all\',this)">All</button><button class="cfb" onclick="fCmt(\'none\',this)">No Spoilers</button><button class="cfb" onclick="fCmt(\'light\',this)">\uD83D\uDFE2 Light</button><button class="cfb" onclick="fCmt(\'medium\',this)">\uD83D\uDFE1 Medium</button><button class="cfb" onclick="fCmt(\'heavy\',this)">\uD83D\uDD34 Heavy</button></div><div id="cml"><p style="color:var(--td);font-size:13px">Loading comments...</p></div>';
  document.getElementById('p-detail').innerHTML=h;
  go('detail');
  await loadComments(rk);
  loadRating(rk);
}

function findRelated(r,max){
  const genres=new Set((r.genres||[]).map(g=>g.toLowerCase()));
  if(!genres.size)return[];
  const scored=[];
  R.forEach((rel,idx)=>{
    if(rel.title===r.title&&rel.media_type===r.media_type)return;
    let score=0;
    (rel.genres||[]).forEach(g=>{if(genres.has(g.toLowerCase()))score+=2});
    if(rel.media_type===r.media_type)score+=1;
    if(score>0)scored.push({rel,idx,score});
  });
  scored.sort((a,b)=>b.score-a.score);
  return scored.slice(0,max).map(s=>s.rel);
}

function pickSp(btn){selSpoiler=btn.dataset.sl;document.querySelectorAll('.slb').forEach(b=>{b.style.background='transparent';b.style.fontWeight='600';b.style.transform='none';b.style.boxShadow='none'});const bgs={none:'var(--el)',light:'var(--slb)',medium:'var(--smb)',heavy:'var(--shb)'};const rings={none:'var(--brd)',light:'var(--sl)',medium:'var(--sm)',heavy:'var(--sh)'};btn.style.background=bgs[selSpoiler]||'transparent';btn.style.boxShadow='0 0 0 2px '+(rings[selSpoiler]||'transparent');btn.style.transform='scale(1.05)'}

async function loadComments(rk){
  try{
    // Try join first
    let{data,error}=await sb.from('comments').select('*,profiles(username,avatar_color)').eq('release_key',rk).order('created_at',{ascending:false});
    if(error){
      console.warn('Join query failed, fetching separately:',error);
      // Fallback: fetch comments then profiles
      const res=await sb.from('comments').select('*').eq('release_key',rk).order('created_at',{ascending:false});
      data=res.data||[];
      if(data.length){
        const uids=[...new Set(data.map(c=>c.user_id))];
        const{data:profs}=await sb.from('profiles').select('id,username,avatar_color').in('id',uids);
        const profMap={};(profs||[]).forEach(p=>profMap[p.id]=p);
        data.forEach(c=>c.profiles=profMap[c.user_id]||{username:'anon',avatar_color:'#ff6b35'});
      }
    }
    detailComments=data||[];
    const el=document.getElementById('cmt-count');
    if(el)el.textContent='Discussion ('+detailComments.length+')';
    renderComments();
  }catch(e){console.error('Load comments exception:',e);detailComments=[];renderComments()}
}

function renderComments(){
  const f=ccf==='all'?detailComments:detailComments.filter(c=>c.spoiler_level===ccf);
  if(!f.length){document.getElementById('cml').innerHTML='<p style="color:var(--td);font-size:13px;padding:20px 0;text-align:center">No comments yet. Be the first!</p>';return}
  const adm=isAdmin();
  document.getElementById('cml').innerHTML=f.map(c=>{
    const s=SP[c.spoiler_level]||SP.none;
    const hs=c.spoiler_level!=='none';
    const ir=rv.has(c.id);const bl=hs&&!ir;
    const p=c.profiles||{};
    const un=p.username||'anon';
    const ac=p.avatar_color||'#ff6b35';
    const init=un.slice(0,2).toUpperCase();
    const isOwn=user&&c.user_id===user.id;
    const isHidden=c.hidden;
    let html='<div class="cm"'+(isHidden&&adm?' style="opacity:0.5;border-color:var(--sh)"':'')+'><div class="cmh"><div class="cmu"><div class="av" style="background:'+ac+'">'+init+'</div><div><div class="cmn">'+esc(un)+(isHidden&&adm?'<span class="hidden-tag">HIDDEN</span>':'')+'</div><div class="cmt">'+timeAgo(c.created_at)+(c.report_count&&adm?' \u00B7 '+c.report_count+' reports':'')+'</div></div></div><span class="sb" style="background:'+s.bg+';color:'+s.c+';border:1px solid '+s.b+'">'+s.l+'</span></div>';
    html+='<div class="cmb'+(bl?' bl':'')+'">'+esc(c.body)+'</div>';
    if(bl)html+='<div class="rvb" onclick="rv.add(\''+c.id+'\');renderComments()">\uD83D\uDC41 Reveal '+c.spoiler_level+' spoiler</div>';
    html+='<div class="cmf"><span onclick="vote(\''+c.id+'\',\'up\')">\u25B2 '+c.upvotes+'</span><span onclick="vote(\''+c.id+'\',\'down\')">\u25BC '+c.downvotes+'</span>';
    if(user&&!isOwn)html+='<span onclick="showReport(\''+c.id+'\')">\uD83D\uDEA9 Report</span>';
    if(isOwn)html+='<span onclick="deleteOwnComment(\''+c.id+'\')">\uD83D\uDDD1 Delete</span>';
    html+='</div>';
    // Mod tools
    if(adm){
      html+='<div class="mod-bar">';
      if(!isHidden)html+='<button class="mod-btn hide" onclick="modHide(\''+c.id+'\')">Hide</button>';
      else html+='<button class="mod-btn ok" onclick="modUnhide(\''+c.id+'\')">Unhide</button>';
      if(c.user_id!==user.id)html+='<button class="mod-btn ban" onclick="modBan(\''+c.user_id+'\',\''+esc(un)+'\')">Ban User</button>';
      if(c.report_count>0)html+='<button class="mod-btn ok" onclick="modDismissReports(\''+c.id+'\')">Dismiss Reports</button>';
      html+='</div>';
    }
    html+='</div>';
    return html;
  }).join('');
}

function fCmt(f,btn){ccf=f;document.querySelectorAll('.cfb').forEach(b=>b.classList.remove('on'));btn.classList.add('on');renderComments()}

async function postComment(){
  const body=document.getElementById('cmt-body').value.trim();
  if(!body)return toast('Write something first!');
  if(!user)return showAuth('login');
  const rk=releaseKey(cr);
  const btn=document.getElementById('post-btn');
  try{
    btn.disabled=true;
    const{data,error}=await sb.from('comments').insert({user_id:user.id,release_key:rk,body:body,spoiler_level:selSpoiler}).select();
    btn.disabled=false;
    if(error){console.error('Post error:',error);toast('Error: '+error.message);return}
    document.getElementById('cmt-body').value='';
    toast('Comment posted!');
    await loadComments(rk);
  }catch(e){btn.disabled=false;console.error('Post exception:',e);toast('Error posting comment')}
}

async function vote(cid,type){
  if(!user)return showAuth('login');
  const{data:existing}=await sb.from('comment_votes').select('*').eq('user_id',user.id).eq('comment_id',cid).single();
  if(existing){
    if(existing.vote_type===type){await sb.from('comment_votes').delete().eq('id',existing.id)}
    else{await sb.from('comment_votes').update({vote_type:type}).eq('id',existing.id)}
  } else {
    await sb.from('comment_votes').insert({user_id:user.id,comment_id:cid,vote_type:type});
  }
  await loadComments(releaseKey(cr));
}

// ═══════ REPORTS & MODERATION ═══════
function showReport(cid){
  if(!user)return showAuth('login');
  const box=document.getElementById('report-box');
  box.innerHTML='<button class="close" onclick="document.getElementById(\'report-modal\').classList.remove(\'show\')">\u2715</button><h2>Report Comment</h2><p class="ms">Why are you reporting this comment?</p><div class="ferr" id="rerr"></div><div class="rpt-reasons"><label><input type="radio" name="rpt" value="spam"><span>Spam or advertising</span></label><label><input type="radio" name="rpt" value="offensive"><span>Offensive or abusive content</span></label><label><input type="radio" name="rpt" value="harassment"><span>Harassment or bullying</span></label><label><input type="radio" name="rpt" value="spoiler_misuse"><span>Spoiler level is wrong</span></label><label><input type="radio" name="rpt" value="other"><span>Other</span></label></div><textarea class="finput" id="rpt-details" placeholder="Additional details (optional)" style="min-height:60px;resize:vertical"></textarea><button class="fbtn" onclick="submitReport(\''+cid+'\')">Submit Report</button>';
  document.getElementById('report-modal').classList.add('show');
}

async function submitReport(cid){
  const reason=document.querySelector('input[name=rpt]:checked');
  if(!reason){const e=document.getElementById('rerr');e.textContent='Please select a reason';e.classList.add('show');return}
  const details=document.getElementById('rpt-details').value.trim();
  const{error}=await sb.from('reports').insert({reporter_id:user.id,comment_id:cid,reason:reason.value,details:details});
  document.getElementById('report-modal').classList.remove('show');
  if(error){if(error.code==='23505')toast('You already reported this comment');else toast('Error: '+error.message);return}
  toast('Report submitted. Thank you.');
}

async function deleteOwnComment(cid){
  if(!confirm('Delete this comment?'))return;
  await sb.from('comments').delete().eq('id',cid).eq('user_id',user.id);
  toast('Comment deleted');
  await loadComments(releaseKey(cr));
}

async function modHide(cid){
  if(!confirm('Hide this comment from all users?'))return;
  await sb.from('comments').update({hidden:true,hidden_reason:'Hidden by moderator'}).eq('id',cid);
  await sb.from('mod_log').insert({moderator_id:user.id,action:'hide_comment',target_comment_id:cid,reason:'Manual hide'});
  toast('Comment hidden');
  await loadComments(releaseKey(cr));
}

async function modUnhide(cid){
  await sb.from('comments').update({hidden:false,hidden_reason:null}).eq('id',cid);
  await sb.from('mod_log').insert({moderator_id:user.id,action:'unhide_comment',target_comment_id:cid});
  toast('Comment restored');
  await loadComments(releaseKey(cr));
}

async function modBan(uid,username){
  if(!confirm('Ban user "'+username+'"? They will not be able to post comments.'))return;
  const reason=prompt('Ban reason (optional):');
  await sb.from('profiles').update({banned:true,banned_at:new Date().toISOString(),ban_reason:reason||'Banned by moderator'}).eq('id',uid);
  await sb.from('mod_log').insert({moderator_id:user.id,action:'ban_user',target_user_id:uid,reason:reason||'Banned by moderator'});
  toast('User banned');
}

async function modDismissReports(cid){
  await sb.from('reports').update({status:'dismissed',reviewed_by:user.id,reviewed_at:new Date().toISOString()}).eq('comment_id',cid).eq('status','pending');
  await sb.from('comments').update({report_count:0}).eq('id',cid);
  await sb.from('mod_log').insert({moderator_id:user.id,action:'dismiss_report',target_comment_id:cid});
  toast('Reports dismissed');
  await loadComments(releaseKey(cr));
}

// ═══════ WATCHLIST ═══════
async function toggleWL(){
  if(!user)return showAuth('login');
  const rk=releaseKey(cr);
  if(isWatchlisted(rk)){
    const{error}=await sb.from('watchlist').delete().eq('user_id',user.id).eq('release_key',rk);
    if(error){console.error('Watchlist remove error:',error);toast('Error removing — try again');return}
    userWatchlist=userWatchlist.filter(w=>w.release_key!==rk);
    toast('Removed from watchlist');
  } else {
    const rd={synopsis:cr.synopsis||'',genres:cr.genres||[],metadata:cr.metadata||{},spoiler_counts:cr.spoiler_counts||{}};
    const{data,error}=await sb.from('watchlist').insert({user_id:user.id,release_key:rk,release_title:cr.title,media_type:cr.media_type,poster_url:cr.poster_url||'',release_data:rd}).select().single();
    if(error){console.error('Watchlist add error:',error);toast('Error adding — try again');return}
    if(data)userWatchlist.push(data);
    toast('Added to watchlist!');
  }
  const wl=isWatchlisted(rk);
  const btn=document.getElementById('wl-btn');
  if(btn){btn.textContent=wl?'\u2705 Watchlisted':'\u2B50 Watchlist';btn.className=wl?'o active':'o'}
}

async function removeFromWL(rk){
  const{error}=await sb.from('watchlist').delete().eq('user_id',user.id).eq('release_key',rk);
  if(error){console.error('Watchlist remove error:',error);toast('Error removing');return}
  userWatchlist=userWatchlist.filter(w=>w.release_key!==rk);
  toast('Removed from watchlist');
  renderAccount();
}

function shareRelease(){
  const url=window.location.origin;
  if(navigator.share){navigator.share({title:cr.title+' on Unreeled',url:url})}
  else if(navigator.clipboard){navigator.clipboard.writeText(cr.title+' — check it out on '+url);toast('Link copied!')}
  else{toast('Share: '+url)}
}

// ═══════ SUBSCRIPTIONS ═══════
async function toggleSub(type,value){
  if(!user)return showAuth('login');
  if(isSubbed(type,value)){
    await sb.from('subscriptions').delete().eq('user_id',user.id).eq('subscription_type',type).eq('subscription_value',value);
    userSubs=userSubs.filter(s=>!(s.subscription_type===type&&s.subscription_value===value));
    toast('Unsubscribed');
  } else {
    const{data}=await sb.from('subscriptions').insert({user_id:user.id,subscription_type:type,subscription_value:value,email_digest:true}).select().single();
    if(data)userSubs.push(data);
    toast('Subscribed! You\'ll get daily updates.');
  }
  renderStreams();
  // Refresh detail page buttons if open
  if(curPage==='detail'&&cr){const ri=R.indexOf(cr);if(ri>=0)openD(ri)}
}

async function toggleStreamSub(name){await toggleSub('stream',name)}

// ═══════ TRENDING ═══════
let TR=D.trending||[];
function openTr(i){cr=TR[i];rv=new Set();ccf='all';selSpoiler='none';const r=cr,c=MC[r.media_type]||MC.movie,sp=r.spoiler_counts||{};const rk=(r.first_seen||vd)+':'+r.media_type+':'+(r.title||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').slice(0,80);
let h='<button class="dbk" onclick="go(\'trending\')">\u2190 Back to Trending</button><div class="dh">'+poster(r,150,210,48)+'<div style="flex:1"><span class="mb '+r.media_type+'">'+c.l+'</span><h1 class="dn">'+esc(r.title)+'</h1><div class="rm">'+meta(r)+(r.genres?.length?'<span class="s">\u00B7</span>'+r.genres.map(esc).join(', '):'')+'</div>'+(r.synopsis?'<p class="dd">'+esc(r.synopsis)+'</p>':'')+'</div></div>'+(r.first_seen?'<p style="font-size:12px;color:var(--td);margin-bottom:16px">First seen: '+fmtD(r.first_seen)+(r.days_seen>1?' \u00B7 Appeared '+r.days_seen+' days':'')+'</p>':'');
h+='<div class="st" id="cmt-count">Discussion</div>';
if(user){h+='<div class="cmp"><textarea id="cmt-body" placeholder="Share your thoughts..."></textarea><div class="cmpf"><div class="spp"><span>Spoiler level:</span><button class="slb" data-sl="none" style="border:1px solid var(--brd);color:var(--td);background:var(--el)" onclick="pickSp(this)">No Spoilers</button><button class="slb" data-sl="light" style="border:1px solid var(--slr);color:var(--sl)" onclick="pickSp(this)">\uD83D\uDFE2 Light</button><button class="slb" data-sl="medium" style="border:1px solid var(--smr);color:var(--sm)" onclick="pickSp(this)">\uD83D\uDFE1 Medium</button><button class="slb" data-sl="heavy" style="border:1px solid var(--shr);color:var(--sh)" onclick="pickSp(this)">\uD83D\uDD34 Heavy</button></div><button class="bps" id="post-btn" onclick="postComment()">Post</button></div></div>'}else{h+='<div class="login-prompt"><a onclick="showAuth(\'signup\')">Sign up</a> or <a onclick="showAuth(\'login\')">log in</a> to comment</div>'}
h+='<div class="cfs"><span>Show:</span><button class="cfb on" onclick="fCmt(\'all\',this)">All</button><button class="cfb" onclick="fCmt(\'none\',this)">No Spoilers</button><button class="cfb" onclick="fCmt(\'light\',this)">\uD83D\uDFE2 Light</button><button class="cfb" onclick="fCmt(\'medium\',this)">\uD83D\uDFE1 Medium</button><button class="cfb" onclick="fCmt(\'heavy\',this)">\uD83D\uDD34 Heavy</button></div><div id="cml"><p style="color:var(--td);font-size:13px">Loading...</p></div>';
document.getElementById('p-detail').innerHTML=h;go('detail');loadComments(rk)}
function renderTrending(){TR=D.trending||[];let h='<h1 class="hero">\uD83D\uDD25 Trending</h1><p class="sub">Titles generating buzz across multiple days</p>';if(!TR.length){h+='<div class="empty"><h2>Not enough data yet</h2><p>Trending builds up as the pipeline runs daily.</p></div>'}else{TR.forEach((t,i)=>{const c=MC[t.media_type]||MC.movie,mp=[],m=t.metadata||{};if(m.artists?.length)mp.push(m.artists[0]);if(m.authors?.length)mp.push(m.authors[0]);if(m.studios?.length)mp.push(m.studios[0]);if(m.networks?.length)mp.push(m.networks[0]);const g=(t.genres||[]).slice(0,3).join(', ');if(g)mp.push(g);h+='<div class="trc" onclick="openTr('+i+')" style="cursor:pointer"><div class="trk">'+(i+1)+'</div>'+poster(t,56,78,20)+'<div class="tri"><div style="display:flex;align-items:center;gap:8px;margin-bottom:2px"><div class="trt">'+esc(t.title)+'</div><span class="mb '+t.media_type+'">'+c.l+'</span></div><div class="trm">'+mp.join('<span class="s">\u00B7</span>')+'</div>'+(t.synopsis?'<p class="rs" style="margin:4px 0">'+esc(t.synopsis)+'</p>':'')+'</div><div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0">'+(t.days_seen>1?'<span class="trd">\uD83D\uDD25 '+t.days_seen+' days</span>':'')+(t.comment_count?'<span style="font-size:11px;color:var(--td)">\uD83D\uDCAC '+t.comment_count+'</span>':'')+'</div></div>'})}document.getElementById('p-trending').innerHTML=h}

// ═══════ ARCHIVE ═══════
function renderArchive(){const a=D.archive||{dates:[],weekly:[],monthly:[]},ds=a.dates||[],wk=a.weekly||[],mo=a.monthly||[];let h='<h1 class="hero">\uD83D\uDCC5 Archive</h1><p class="sub">Browse past releases by day, week, or month</p>';if(ds.length){const tot=ds.reduce((s,d)=>s+d.total,0),avg=Math.round(tot/ds.length);h+='<div class="arcs"><div class="arci"><em>'+ds.length+'</em><small>Days</small></div><div class="arci"><em>'+tot.toLocaleString()+'</em><small>Releases</small></div><div class="arci"><em>'+avg+'</em><small>Avg/day</small></div></div>'}if(mo.length){h+='<div class="sect" style="margin-top:0">\uD83D\uDCC6 Monthly</div><div class="sg">';mo.forEach(m=>{const ti=Object.keys(m.types||{}).map(t=>(MC[t]||{}).i||'').filter(Boolean).join(' ');h+='<div class="sc"><div class="sct"><div class="si">\uD83D\uDCC6</div><span style="font-size:11px;color:var(--td)">'+m.days+' days</span></div><h3>'+m.month+'</h3><p>'+m.total.toLocaleString()+' releases</p><div class="scs">'+ti+'</div></div>'});h+='</div>'}if(wk.length){h+='<div class="sect">\uD83D\uDCC5 Weekly</div><div class="sg">';wk.forEach(w=>{const ti=Object.keys(w.types||{}).map(t=>(MC[t]||{}).i||'').filter(Boolean).join(' ');h+='<div class="sc"><div class="sct"><div class="si">\uD83D\uDCC5</div><span style="font-size:11px;color:var(--td)">'+w.days+' days</span></div><h3>'+w.week+'</h3><p>'+w.total.toLocaleString()+' releases</p><div class="scs">'+ti+'</div></div>'});h+='</div>'}h+='<div class="sect">\uD83D\uDCC4 Daily</div>';if(!ds.length){h+='<div class="empty"><h2>No archive data yet</h2><p>Data builds as the pipeline runs daily.</p></div>'}else{h+='<div class="arcg">';ds.slice().reverse().forEach(d=>{const il=d.date===D.latest_date,ti=Object.keys(d.types||{}).map(t=>'<span>'+(MC[t]||{}).i+'</span>').join('');h+='<div class="arcd'+(il?' now':'')+'" onclick="loadDate(\''+d.date+'\');go(\'feed\')"><div class="arcd-dt">'+d.date.slice(5)+'</div><div class="arcd-n">'+d.total+'</div><div class="arcd-l">releases</div><div class="arcd-t">'+ti+'</div></div>'});h+='</div>'}document.getElementById('p-archive').innerHTML=h}

// ═══════ CALENDAR ═══════
let calYear,calMonth;
(function(){const n=new Date();calYear=n.getFullYear();calMonth=n.getMonth()})();

function renderCalendar(){
  const ds=D.archive?D.archive.dates||[]:[];
  const dateMap={};ds.forEach(d=>dateMap[d.date]=d);
  const today=new Date().toISOString().slice(0,10);
  const mn=['January','February','March','April','May','June','July','August','September','October','November','December'];

  let h='<h1 class="hero">\uD83D\uDCC5 Release Calendar</h1><p class="sub">Visual overview of daily releases</p>';
  h+='<div class="cal"><div class="cal-hd"><button onclick="calPrev()">\u2190 Prev</button><h2>'+mn[calMonth]+' '+calYear+'</h2><button onclick="calNext()">Next \u2192</button></div>';

  // Day of week headers
  h+='<div class="cal-grid">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>h+='<div class="cal-dow">'+d+'</div>');

  // Calculate first day and total days
  const first=new Date(calYear,calMonth,1).getDay();
  const totalDays=new Date(calYear,calMonth+1,0).getDate();

  // Empty cells before first day
  for(let i=0;i<first;i++)h+='<div class="cal-day empty"></div>';

  // Day cells
  for(let d=1;d<=totalDays;d++){
    const ds2=calYear+'-'+String(calMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const info=dateMap[ds2];
    const isToday=ds2===today;
    const hasData=!!info;

    h+='<div class="cal-day'+(hasData?' has':'')+(isToday?' today':'')+'"'+(hasData?' onclick="loadDate(\''+ds2+'\');go(\'feed\')"':'')+'>';
    h+='<div class="cd-num">'+d+'</div>';
    if(info){
      h+='<div class="cd-ct">'+info.total+'</div>';
      h+='<div class="cd-dots">';
      const types=info.types||{};
      for(const[t,cnt]of Object.entries(types)){
        const col=(MC[t]||{}).c||'#666';
        if(cnt>0)h+='<span style="background:'+col+'" title="'+((MC[t]||{}).l||t)+': '+cnt+'"></span>';
      }
      h+='</div>';
    }
    h+='</div>';
  }

  h+='</div>';

  // Legend
  h+='<div class="cal-legend">';
  for(const[t,c]of Object.entries(MC)){
    h+='<span><i style="background:'+c.c+'"></i>'+c.l+'</span>';
  }
  h+='</div></div>';

  // Upcoming section — show next 7 days with data
  const upcoming=[];
  for(let i=0;i<30;i++){
    const nd=new Date();nd.setDate(nd.getDate()+i);
    const nds=nd.toISOString().slice(0,10);
    if(dateMap[nds])upcoming.push(dateMap[nds]);
    if(upcoming.length>=5)break;
  }
  if(upcoming.length){
    h+='<div class="sect">\uD83D\uDD1C Upcoming Days with Releases</div>';
    h+='<div class="arcg">';
    upcoming.forEach(d=>{
      const il=d.date===D.latest_date;
      const ti=Object.keys(d.types||{}).map(t=>'<span>'+(MC[t]||{}).i+'</span>').join('');
      h+='<div class="arcd'+(il?' now':'')+'" onclick="loadDate(\''+d.date+'\');go(\'feed\')"><div class="arcd-dt">'+fmtD(d.date)+'</div><div class="arcd-n">'+d.total+'</div><div class="arcd-l">releases</div><div class="arcd-t">'+ti+'</div></div>';
    });
    h+='</div>';
  }

  document.getElementById('p-calendar').innerHTML=h;
}

function calPrev(){calMonth--;if(calMonth<0){calMonth=11;calYear--}renderCalendar()}
function calNext(){calMonth++;if(calMonth>11){calMonth=0;calYear++}renderCalendar()}

// ═══════ STREAMS ═══════
function renderStreams(){let h='<div class="shd"><h1 class="hero">Your Streams</h1><p>Subscribe to genres, platforms, franchises, and series.'+(user?'':' <a onclick="showAuth(\'signup\')" style="color:var(--accent);cursor:pointer">Sign up</a> to enable subscriptions.')+'</p></div>';
// Media type subscriptions
h+='<h3 class="sect" style="margin-top:0">Media Types</h3><p style="font-size:12px;color:var(--td);margin-bottom:12px">Subscribe to get daily email digests for these categories</p><div class="sg">';
for(const[t,c]of Object.entries(MC)){const on=isSubbed('media_type',t);h+='<div class="sc"><div class="sct"><div class="si">'+c.i+'</div><button class="ssb'+(on?' on':'')+'" onclick="toggleSub(\'media_type\',\''+t+'\')">'+(on?'\u2713 Subscribed':'Subscribe')+'</button></div><h3>'+c.l+' Releases</h3><p>Daily digest of new '+c.l.toLowerCase()+' releases</p></div>'}
h+='</div>';
STM.forEach((s,si)=>{h+='<h3 class="sect">'+s.t+'</h3><div class="sg">';s.items.forEach(x=>{const on=isSubbed('stream',x.n);h+='<div class="sc"><div class="sct"><div class="si">'+x.i+'</div><button class="ssb'+(on?' on':'')+'" onclick="toggleStreamSub(\''+x.n.replace(/'/g,"\\'")+'\')">'+(on?'\u2713 Subscribed':'Subscribe')+'</button></div><h3>'+x.n+'</h3><p>'+x.d+'</p><div class="scs"><span>\uD83D\uDCE6 '+x.f+'</span></div></div>'});h+='</div>'});
document.getElementById('p-streams').innerHTML=h}

// ═══════ ACCOUNT ═══════
function openWatchlistItem(rk,title,mtype){
  const parts=rk.split(':');
  const dateStr=parts[0];
  const tl=title.toLowerCase();
  // Try the original date
  if(D.historical&&D.historical[dateStr]){
    const rel=D.historical[dateStr];
    const idx=rel.findIndex(r=>(r.title||'').toLowerCase()===tl&&r.media_type===mtype);
    if(idx>=0){vd=dateStr;R=rel;openD(idx);return}
  }
  // Search all dates
  for(const d of dates){
    if(D.historical&&D.historical[d]){
      const rel=D.historical[d];
      const idx=rel.findIndex(r=>(r.title||'').toLowerCase()===tl&&r.media_type===mtype);
      if(idx>=0){vd=d;R=rel;openD(idx);return}
    }
  }
  // Not in processed data — rebuild from watchlist stored data
  const wlItem=userWatchlist.find(w=>w.release_key===rk);
  const rd=(wlItem&&wlItem.release_data)||{};
  const c=MC[mtype]||MC.movie;
  cr={title:title,media_type:mtype,poster_url:(wlItem&&wlItem.poster_url)||'',synopsis:rd.synopsis||'',genres:rd.genres||[],metadata:rd.metadata||{},spoiler_counts:rd.spoiler_counts||{},comment_count:0};
  rv=new Set();ccf='all';selSpoiler='none';
  const sp=cr.spoiler_counts;
  const wl=true;
  const subbed=user&&isSubbed('media_type',mtype);

  let h='<button class="dbk" onclick="go(\'account\')">\u2190 Back</button><div class="dh">'+poster(cr,150,210,48)+'<div style="flex:1"><span class="mb '+mtype+'">'+c.l+'</span><h1 class="dn">'+esc(title)+'</h1><div class="rm">'+meta(cr)+(cr.genres.length?'<span class="s">\u00B7</span>'+cr.genres.map(esc).join(', '):'')+'</div>'+(cr.synopsis?'<p class="dd">'+esc(cr.synopsis)+'</p>':'')+'<div class="da"><button class="p'+(subbed?' active':'')+'" onclick="toggleSub(\'media_type\',\''+mtype+'\')">\uD83D\uDCE1 '+(subbed?'Following '+c.l:'Follow '+c.l)+'</button><button class="o" onclick="shareRelease()">\uD83D\uDD17 Share</button><button class="o active" onclick="toggleWL()" id="wl-btn">\u2705 Watchlisted</button></div></div></div>';
  h+='<div class="spb"><div class="sps sl"><em>'+(sp.light||0)+'</em><small>Light</small></div><div class="sps sm"><em>'+(sp.medium||0)+'</em><small>Medium</small></div><div class="sps sv"><em>'+(sp.heavy||0)+'</em><small>Heavy</small></div></div>';

  // Streaming availability
  const strm=(cr.metadata||{}).streaming;
  if(strm&&Object.keys(strm).length){
    h+='<div style="padding:14px;background:var(--card);border:1px solid var(--brd);border-radius:12px;margin-bottom:16px"><div style="font-size:13px;font-weight:600;margin-bottom:8px">\uD83D\uDCFA Where to Watch</div><div style="display:flex;gap:6px;flex-wrap:wrap">';
    for(const[name,info]of Object.entries(strm)){const badge=info.type==='sub'?'var(--slb)':info.type==='rent'?'var(--smb)':'var(--el)';const lbl=info.type==='sub'?'Stream':info.type==='rent'?'Rent':info.type==='buy'?'Buy':'Watch';h+='<a '+(info.url?'href="'+esc(info.url)+'" target="_blank"':'')+'style="display:inline-flex;align-items:center;gap:4px;padding:5px 10px;background:'+badge+';border:1px solid var(--brd);border-radius:6px;font-size:11.5px;color:var(--text);text-decoration:none"><span style="font-size:10px;color:var(--td)">'+lbl+'</span> '+esc(name)+'</a>'}
    h+='</div></div>'}

  h+='<div class="st" id="cmt-count">Discussion</div>';
  if(user){h+='<div class="cmp"><textarea id="cmt-body" placeholder="Share your thoughts..."></textarea><div class="cmpf"><div class="spp"><span>Spoiler level:</span><button class="slb" data-sl="none" style="border:1px solid var(--brd);color:var(--td);background:var(--el)" onclick="pickSp(this)">No Spoilers</button><button class="slb" data-sl="light" style="border:1px solid var(--slr);color:var(--sl)" onclick="pickSp(this)">\uD83D\uDFE2 Light</button><button class="slb" data-sl="medium" style="border:1px solid var(--smr);color:var(--sm)" onclick="pickSp(this)">\uD83D\uDFE1 Medium</button><button class="slb" data-sl="heavy" style="border:1px solid var(--shr);color:var(--sh)" onclick="pickSp(this)">\uD83D\uDD34 Heavy</button></div><button class="bps" id="post-btn" onclick="postComment()">Post</button></div></div>'}else{h+='<div class="login-prompt"><a onclick="showAuth(\'signup\')">Sign up</a> or <a onclick="showAuth(\'login\')">log in</a> to comment</div>'}
  h+='<div class="cfs"><span>Show:</span><button class="cfb on" onclick="fCmt(\'all\',this)">All</button><button class="cfb" onclick="fCmt(\'none\',this)">No Spoilers</button><button class="cfb" onclick="fCmt(\'light\',this)">\uD83D\uDFE2 Light</button><button class="cfb" onclick="fCmt(\'medium\',this)">\uD83D\uDFE1 Medium</button><button class="cfb" onclick="fCmt(\'heavy\',this)">\uD83D\uDD34 Heavy</button></div><div id="cml"><p style="color:var(--td);font-size:13px">Loading...</p></div>';
  document.getElementById('p-detail').innerHTML=h;go('detail');loadComments(rk);
}
function renderAccount(){
  if(!user||!profile){document.getElementById('p-account').innerHTML='<div class="empty"><h2>Not logged in</h2><p><a onclick="showAuth(\'login\')" style="color:var(--accent);cursor:pointer">Log in</a> to view your account.</p></div>';return}
  let h='<h1 class="hero">My Account</h1>';
  h+='<div style="padding:20px;background:var(--card);border:1px solid var(--brd);border-radius:12px;margin-bottom:20px"><div style="display:flex;align-items:center;gap:14px;margin-bottom:16px"><div class="av" style="background:'+profile.avatar_color+';width:48px;height:48px;font-size:18px;border-radius:12px">'+profile.username.slice(0,2).toUpperCase()+'</div><div><div style="font-size:18px;font-weight:600">'+esc(profile.username)+'</div><div style="font-size:12px;color:var(--td)">'+esc(user.email)+'</div></div></div></div>';
  // Subscriptions
  h+='<div class="st">My Subscriptions ('+userSubs.length+')</div>';
  if(userSubs.length){userSubs.forEach(s=>{h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--card);border:1px solid var(--brd);border-radius:8px;margin-bottom:6px"><span style="font-size:13px">'+esc(s.subscription_value)+' <span style="color:var(--td);font-size:11px">('+s.subscription_type+')</span></span><button class="ssb on" onclick="toggleSub(\''+s.subscription_type+'\',\''+s.subscription_value.replace(/'/g,"\\'")+'\')">\u2713 Subscribed</button></div>'})}else{h+='<p style="color:var(--td);font-size:13px;padding:16px 0">No subscriptions yet. <a onclick="go(\'streams\')" style="color:var(--accent);cursor:pointer">Browse streams</a></p>'}
  // Watchlist
  h+='<div class="st" style="margin-top:24px">My Watchlist ('+userWatchlist.length+')</div>';
  if(userWatchlist.length){userWatchlist.forEach(w=>{const c=MC[w.media_type]||MC.movie;h+='<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--card);border:1px solid var(--brd);border-radius:8px;margin-bottom:6px;transition:all .15s" onmouseover="this.style.borderColor=\'var(--bl)\'" onmouseout="this.style.borderColor=\'var(--brd)\'"><span class="mb '+w.media_type+'">'+c.l+'</span><span style="font-size:13px;flex:1;cursor:pointer" onclick="openWatchlistItem(\''+esc(w.release_key)+'\',\''+esc(w.release_title)+'\',\''+w.media_type+'\')">'+esc(w.release_title)+'</span><button onclick="event.stopPropagation();removeFromWL(\''+esc(w.release_key)+'\')" style="padding:4px 10px;font-size:11px;color:var(--sh);background:var(--shb);border:1px solid var(--shr);border-radius:6px;cursor:pointer;white-space:nowrap">\u2715 Remove</button></div>'})}else{h+='<p style="color:var(--td);font-size:13px;padding:16px 0">No items in watchlist yet.</p>'}
  document.getElementById('p-account').innerHTML=h}

// ═══════ INIT ═══════
document.addEventListener('DOMContentLoaded',async()=>{
  sb=window.supabase.createClient(SB_URL,SB_KEY);
  await loadUser();
  renderNav();renderFeed();renderTrending();renderArchive();renderCalendar();renderStreams();renderAccount();
  // Listen for auth changes
  sb.auth.onAuthStateChange(async(event)=>{
    if(event==='SIGNED_IN'||event==='SIGNED_OUT'){await loadUser();renderNav();renderStreams();renderAccount()}
  });
  // Register service worker for PWA
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  }
});

// ═══════ NOTIFICATIONS ═══════
async function requestNotifications(){
  if(!('Notification' in window)){toast('Notifications not supported');return}
  const perm=await Notification.requestPermission();
  if(perm==='granted'){toast('Notifications enabled!');return true}
  toast('Notifications blocked');return false;
}

document.addEventListener('click',e=>{const um=document.getElementById('umenu');if(um.classList.contains('show')&&!e.target.closest('.user-pill')&&!e.target.closest('.umenu'))um.classList.remove('show')});
</script>
</body>
</html>
